<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ABF CLUB RADIO ‚Äì Official clubbing webradio from RadioABF.com</title>
  <meta name="description" content="ABF CLUB RADIO ‚Äì Official clubbing webradio from RadioABF.com." />

  <!-- Dynamic favicon -->
  <link id="dynamicFavicon" rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAQAAAC1+jfqAAAAK0lEQVR42mP8z/D/PwMDA8NARQYGBgYGhjEwMDAwYBgGE0EAAKxSBQm+2Z0AAAAASUVORK5CYII=" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#05070c;
      --neon-blue:#3ccfff;
      --neon-purple:#8a5cff;
      --text:#e8f7ff;
      --muted:#8fa3b0;

      /* Audio-driven */
      --beat:0;          /* 0..1 (overall energy) */
      --kick:0;          /* 0..1 (bass transient) */
      --hue:0;           /* 0..360 (color drift) */

      /* Layout */
      --player-h:220px;  /* auto-updated by JS */
    }

    *{box-sizing:border-box;margin:0;padding:0}

    body{
      font-family:'Orbitron',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#0b1630,var(--bg));
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* Base ambient */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      background:
        radial-gradient(circle at center,rgba(60,207,255,.10),transparent 60%),
        radial-gradient(circle at 30% 70%,rgba(138,92,255,.10),transparent 60%),
        repeating-radial-gradient(circle at center, rgba(255,255,255,.02) 0 1px, transparent 1px 6px);
      animation:pulseBg 8s infinite alternate;
    }

    @keyframes pulseBg{
      from{opacity:.55; filter:hue-rotate(0deg)}
      to{opacity:1; filter:hue-rotate(20deg)}
    }

    /* FULL CLUB: moving lasers + scanlines (beat-synced + color drift) */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;
      background:
        /* diagonal laser sweep */
        linear-gradient(115deg,
          transparent 0%,
          hsla(calc(200 + (var(--beat) * 80)),100%,60%,.18) 18%,
          transparent 36%,
          hsla(calc(270 + (var(--beat) * 60)),100%,65%,.16) 54%,
          transparent 72%),
        /* scanlines */
        repeating-linear-gradient(180deg, rgba(255,255,255,.04) 0px, rgba(255,255,255,.04) 1px, transparent 3px, transparent 7px);
      mix-blend-mode: screen;
      opacity: calc(.14 + (var(--beat) * .16) + (var(--kick) * .12));
      transform: translate3d(0,0,0);
      filter: hue-rotate(calc(var(--hue) * 1deg)) saturate(1.15);
      animation: lasers 10s linear infinite;
    }

    @keyframes lasers{
      0%{ transform: translate3d(-10%, -3%, 0) rotate(0deg); }
      50%{ transform: translate3d(10%, 3%, 0) rotate(0.6deg); }
      100%{ transform: translate3d(-10%, -3%, 0) rotate(0deg); }
    }

    /* Film grain */
    .grain-layer{
      position:fixed;
      inset:-30px;
      pointer-events:none;
      z-index:4;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="2" stitchTiles="stitch"/></filter><rect width="160" height="160" filter="url(%23n)" opacity="0.25"/></svg>');
      opacity:.10;
      mix-blend-mode: overlay;
      animation: grain 6s steps(10) infinite;
    }

    @keyframes grain{
      0%{ transform: translate3d(0,0,0); }
      10%{ transform: translate3d(-2%, -1%, 0); }
      20%{ transform: translate3d(-4%, 2%, 0); }
      30%{ transform: translate3d(3%, -3%, 0); }
      40%{ transform: translate3d(1%, 4%, 0); }
      50%{ transform: translate3d(-3%, 1%, 0); }
      60%{ transform: translate3d(4%, 0%, 0); }
      70%{ transform: translate3d(0%, -4%, 0); }
      80%{ transform: translate3d(-1%, 3%, 0); }
      90%{ transform: translate3d(2%, -2%, 0); }
      100%{ transform: translate3d(0,0,0); }
    }

    /* Kick strobe: subtle flash on bass transients */
    .strobe-layer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:5;
      background:
        radial-gradient(circle at 50% 40%, rgba(60,207,255,.40), transparent 62%),
        radial-gradient(circle at 60% 60%, rgba(138,92,255,.22), transparent 65%);
      opacity: calc(var(--kick) * .22);
      transition: opacity 60ms linear;
      mix-blend-mode: screen;
    }

    header{padding:56px 20px 34px;text-align:center}

    /* BEAT-SYNC SVG LOGO (Header) */
    .logo-wrap{
      width:176px;
      margin:0 auto 18px;
      transform:scale(calc(1 + var(--beat) * 0.12));
      transition:transform .1s linear;
    }
    .logo-svg{
      width:100%;
      height:auto;
      filter:drop-shadow(0 0 calc(12px + var(--beat) * 28px) rgba(60,207,255,.9));
    }
    .logo-ring{stroke-dasharray:140 26;animation:spin 3.5s linear infinite}
    @keyframes spin{to{stroke-dashoffset:-166}}

    /* Dynamic waveform (SVG) */
    .waveform{
      fill:none;
      stroke: var(--neon-blue);
      stroke-width: 4;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: .9;
      filter: drop-shadow(0 0 10px rgba(60,207,255,.65));
    }

    header h1{
      font-size:clamp(2.2rem,6vw,3.7rem);
      letter-spacing:5px;
      color:var(--neon-blue);
      text-shadow:0 0 15px rgba(60,207,255,.9),0 0 40px rgba(138,92,255,.6);
    }
    header p{margin-top:10px;color:var(--muted);font-size:.9rem}

    main{max-width:900px;margin:auto;padding:0 20px}

    section{
      margin-bottom:32px;
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid rgba(60,207,255,.22);
      border-radius:18px;
      padding:24px;
      box-shadow:
        0 0 0 1px rgba(138,92,255,.10) inset,
        0 20px 60px rgba(0,0,0,.55),
        0 0 40px rgba(60,207,255,.06);
      backdrop-filter: blur(10px);
      transition: .25s;
    }

    section:hover{
      border-color: rgba(60,207,255,.35);
      box-shadow:
        0 0 0 1px rgba(138,92,255,.14) inset,
        0 26px 70px rgba(0,0,0,.62),
        0 0 55px rgba(60,207,255,.10);
      transform: translateY(-1px);
    }

    section h2{
      font-size:1.05rem;
      margin-bottom:16px;
      color:var(--neon-purple);
      letter-spacing:3px;
      position:relative;
      padding-bottom:10px;
    }

    section h2::after{
      content:"";
      position:absolute;
      left:0; bottom:0;
      width:140px; height:2px;
      background: linear-gradient(90deg, var(--neon-purple), transparent);
      box-shadow: 0 0 18px rgba(138,92,255,.65);
    }

    .now-playing{font-size:1.5rem;color:var(--neon-blue);text-shadow:0 0 12px rgba(60,207,255,.7)}

    ul.tracks{list-style:none}
    ul.tracks li{
      padding:9px 0;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:.85rem;
      color:var(--muted);
      display:flex;
      gap:10px;
      align-items:baseline;
    }
    ul.tracks li:last-child{border-bottom:none}
    .track-time{opacity:.6;min-width:52px;display:inline-block}
    .track-title{flex:1;color:rgba(232,247,255,.85)}

    .about{color:var(--muted);line-height:1.55}
    .about-title{color:var(--neon-blue);letter-spacing:3px;font-size:.95rem;text-shadow:0 0 10px rgba(60,207,255,.45);margin-bottom:6px}
    .about-subtitle{color:var(--text);opacity:.9;font-size:.8rem;margin-bottom:10px}
    .about-text{font-size:.78rem;margin-bottom:6px}

    /* Spacer so the last content is never hidden behind the fixed player */
    .bottom-spacer{
      height: calc(var(--player-h, 220px) + 72px);
      width: 100%;
    }

    /* PLAYER (DJ CONSOLE MODE) */
    .player{
      position:fixed;
      bottom:0;left:0;right:0;
      background:
        linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)),
        linear-gradient(90deg,#0b1630,#05070c);
      border-top:1px solid rgba(60,207,255,.42);
      padding:8px 12px calc(10px + env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      gap:8px;
      box-shadow:
        0 -18px 65px rgba(0,0,0,.78),
        0 0 calc(22px + (var(--beat) * 30px)) rgba(60,207,255,.18);
      backdrop-filter: blur(10px);
      z-index:60;
    }

    .player-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      width:100%;
      padding:8px 10px;
      border-radius:16px;
      background: rgba(255,255,255,.025);
      border: 1px solid rgba(255,255,255,.07);
      box-shadow:
        0 0 0 1px rgba(60,207,255,.10) inset,
        0 16px 44px rgba(0,0,0,.40);
      position:relative;
      overflow:hidden;
    }

    .player-top::before{
      content:"";
      position:absolute;
      inset:-40px -60px auto -60px;
      height:90px;
      background: radial-gradient(circle at 30% 40%, rgba(60,207,255,.18), transparent 60%);
      opacity: calc(.35 + var(--beat) * .35);
      pointer-events:none;
    }

    .player-top::after{
      content:"";
      position:absolute;
      inset:auto -40px -50px -40px;
      height:90px;
      background: radial-gradient(circle at 70% 50%, rgba(138,92,255,.16), transparent 60%);
      opacity: calc(.25 + var(--beat) * .30);
      pointer-events:none;
    }

    .player-left{
      min-width:220px;
      display:flex;
      align-items:center;
      gap:12px;
      position:relative;
      z-index:1;
    }

    .player-logo{
      width:36px;height:36px;flex:0 0 auto;
      transform:scale(calc(1 + var(--beat) * 0.10));
      filter:drop-shadow(0 0 calc(10px + var(--beat) * 18px) rgba(60,207,255,.9));
      transition:transform .1s linear, filter .1s linear;
    }

    .player-track{display:flex;flex-direction:column;align-items:flex-start;gap:4px}
    .player-track-label{font-size:.6rem;letter-spacing:2px;color:var(--muted)}
    .player-track-title{font-size:.85rem;color:var(--neon-blue);text-shadow:0 0 10px rgba(60,207,255,.7)}

    .player-right{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      z-index:1;
    }

    .controls, .stream-select{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px 10px;
      border-radius:14px;
      background: rgba(11,22,48,.55);
      border: 1px solid rgba(60,207,255,.20);
      box-shadow:
        0 0 0 1px rgba(255,255,255,.05) inset,
        0 0 calc(10px + (var(--beat) * 14px)) rgba(60,207,255,.10);
    }

    .btn{
      width:40px;height:40px;border-radius:50%;cursor:pointer;
      border:1px solid rgba(60,207,255,.55);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.10), rgba(255,255,255,0) 60%),
        radial-gradient(circle at 70% 70%, rgba(60,207,255,.08), rgba(0,0,0,0) 55%),
        rgba(0,0,0,.22);
      color:var(--neon-blue);
      font-size:18px;
      box-shadow:
        0 0 calc(10px + (var(--beat) * 16px)) rgba(60,207,255,.40),
        0 10px 18px rgba(0,0,0,.45);
      transition:transform .12s ease, box-shadow .2s ease, border-color .2s ease;
      display:grid;
      place-items:center;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:hover{transform:translateY(-1px);box-shadow:0 0 26px rgba(60,207,255,.9), 0 14px 22px rgba(0,0,0,.55)}
    .btn:active{transform:translateY(0px) scale(.98)}
    .btn.playing{box-shadow:0 0 30px rgba(138,92,255,1), 0 14px 22px rgba(0,0,0,.55);border-color:rgba(138,92,255,.75);color:var(--neon-purple)}

    .volume{
      -webkit-appearance:none;
      width:110px;
      height:6px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(60,207,255,.65), rgba(60,207,255,.20));
      outline:none;
      box-shadow:0 0 calc(10px + (var(--beat) * 12px)) rgba(60,207,255,.45);
    }

    .volume::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:16px;height:16px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,0) 55%), var(--neon-blue);
      box-shadow:0 0 14px rgba(60,207,255,1);
      border:1px solid rgba(255,255,255,.10);
    }

    .stream-select select{
      background: rgba(5,7,12,.65);
      color:var(--text);
      border:1px solid rgba(60,207,255,.35);
      border-radius:999px;
      padding:8px 12px;
      font-family:'Orbitron',sans-serif;
      outline:none;
      box-shadow:0 0 12px rgba(60,207,255,.10);
    }

    /* Visualizer as a slim VU strip */
    #visualizer{
      height:24px;
      width:100%;
      border-radius:14px;
      background:rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.06);
    }

    .player-footer{
      text-align:center;
      font-size:.65rem;
      color:#556b78;
      padding:6px 4px 2px;
      opacity:.85;
    }
    .player-footer a{color:var(--neon-blue);text-decoration:none}

    .player-status{
      margin-top:4px;
      opacity:.75;
      font-size:.6rem;
      letter-spacing:1px;
    }

    /* CLUB SCREEN (Fullscreen party mode) */
    .club-screen-overlay{
      position: fixed;
      inset: 0;
      z-index: 40;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      pointer-events: none;
    }

    body.club-screen .club-screen-overlay{ display: flex; }

    body.club-screen header,
    body.club-screen main{
      opacity: 0;
      transform: scale(.98);
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
    }

    .club-stage{
      width: min(980px, 96vw);
      display: grid;
      gap: 18px;
      justify-items: center;
      text-align: center;
    }

    .club-title{
      font-size: clamp(1.4rem, 4vw, 2.4rem);
      letter-spacing: 6px;
      color: var(--neon-blue);
      text-shadow: 0 0 18px rgba(60,207,255,.85), 0 0 60px rgba(138,92,255,.35);
      filter: hue-rotate(calc(var(--hue) * 1deg));
    }

    .club-now{
      font-size: clamp(1rem, 2.7vw, 1.35rem);
      color: rgba(232,247,255,.90);
      text-shadow: 0 0 12px rgba(60,207,255,.35);
      max-width: 70ch;
    }

    .club-logo{
      width: min(360px, 70vw);
      transform: scale(calc(1 + var(--beat) * .14));
      filter: drop-shadow(0 0 calc(18px + var(--beat) * 48px) rgba(60,207,255,.9)) hue-rotate(calc(var(--hue) * 1deg));
    }

    #clubViz{
      width: min(980px, 96vw);
      height: 180px;
      border-radius: 22px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.07);
      box-shadow: 0 0 0 1px rgba(60,207,255,.10) inset, 0 0 55px rgba(60,207,255,.10);
    }

    @media(max-width:700px){
      header{padding:46px 16px 32px}
      .logo-wrap{width:150px;margin-bottom:18px}

      .player-top{flex-direction:column;align-items:stretch;gap:10px}
      .player-left{min-width:0}
      .controls, .stream-select{justify-content:space-between}
      .volume{width:100%}
      .stream-select select{width:100%}

      #clubViz{ height: 140px; }
    }

    @media (prefers-reduced-motion: reduce){
      body::after{ animation: none; }
      .grain-layer{ animation: none; }
      .logo-ring{ animation: none; }
    }
  </style>
</head>
<body>
  <div class="grain-layer" aria-hidden="true"></div>
  <div class="strobe-layer" aria-hidden="true"></div>

  <!-- CLUB SCREEN overlay (shown in fullscreen / club mode) -->
  <div id="clubScreen" class="club-screen-overlay" aria-hidden="true">
    <div class="club-stage">
      <svg class="club-logo" viewBox="0 0 200 200" aria-hidden="true">
        <defs>
          <linearGradient id="lgClub" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#3ccfff" />
            <stop offset="1" stop-color="#8a5cff" />
          </linearGradient>
        </defs>
        <circle cx="100" cy="100" r="88" fill="none" stroke="rgba(60,207,255,.25)" stroke-width="2" />
        <circle class="logo-ring" cx="100" cy="100" r="74" fill="none" stroke="url(#lgClub)" stroke-width="10" stroke-linecap="round" />
        <path id="waveClub" class="waveform" d="M40 100 L160 100" />
      </svg>
      <div class="club-title">ABF CLUB RADIO</div>
      <div id="clubNow" class="club-now">Live ‚Äì ABF CLUB RADIO</div>
      <canvas id="clubViz"></canvas>
    </div>
  </div>

<header id="top">
  <div class="logo-wrap" aria-hidden="true">
    <svg class="logo-svg" viewBox="0 0 200 200" role="img" aria-label="ABF Club Radio">
      <defs>
        <linearGradient id="lgHeader" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0" stop-color="#3ccfff" />
          <stop offset="1" stop-color="#8a5cff" />
        </linearGradient>
      </defs>
      <circle cx="100" cy="100" r="88" fill="none" stroke="rgba(60,207,255,.25)" stroke-width="2" />
      <circle class="logo-ring" cx="100" cy="100" r="74" fill="none" stroke="url(#lgHeader)" stroke-width="8" stroke-linecap="round" />
      <path id="waveHeader" class="waveform" d="M40 100 L160 100" />
    </svg>
  </div>

  <h1>ABF CLUB RADIO</h1>
  <p>Electronic ‚Ä¢ Clubbing ‚Ä¢ Night Vibes</p>
</header>

<main>
  <section>
    <h2>NOW PLAYING</h2>
    <div class="now-playing" id="nowPlaying">Loading‚Ä¶</div>
  </section>

  <section>
    <h2>RECENT TRACKS</h2>
    <ul class="tracks" id="recentTracks"></ul>
  </section>

  <section>
    <h2>ABOUT ABF CLUB RADIO</h2>
    <div class="about" aria-label="About ABF Club Radio">
      <div class="about-title">ABF CLUB RADIO</div>
      <div class="about-subtitle">The club extension of the ABF CLUB radio show</div>
      <div class="about-text">Pure underground energy ‚Äî house, techno, breaks, progressive &amp; rave culture</div>
      <div class="about-text">24/7 non-stop DJs set brought to you by the Radio ABF crew.</div>
    </div>
  </section>
</main>

<div class="bottom-spacer" aria-hidden="true"></div>

<div class="player" id="player">
  <div class="player-top">
    <div class="player-left">
      <svg class="player-logo" viewBox="0 0 200 200" aria-hidden="true">
        <defs>
          <linearGradient id="lgPlayer" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="#3ccfff" />
            <stop offset="1" stop-color="#8a5cff" />
          </linearGradient>
        </defs>
        <circle cx="100" cy="100" r="88" fill="none" stroke="rgba(60,207,255,.25)" stroke-width="2" />
        <circle class="logo-ring" cx="100" cy="100" r="74" fill="none" stroke="url(#lgPlayer)" stroke-width="8" stroke-linecap="round" />
        <path id="wavePlayer" class="waveform" d="M40 100 L160 100" />
      </svg>

      <div class="player-track">
        <div class="player-track-label">NOW PLAYING</div>
        <div id="playerTitle" class="player-track-title">Live ‚Äì ABF CLUB RADIO</div>
      </div>
    </div>

    <div class="player-right">
      <div class="controls">
        <button id="fullBtn" class="btn" aria-label="Fullscreen / Club Screen">‚õ∂</button>
        <button id="playBtn" class="btn" aria-label="Play / Pause">‚ñ∂</button>
        <button id="muteBtn" class="btn" aria-label="Mute">üîä</button>
        <input id="volume" class="volume" type="range" min="0" max="1" step="0.01" value="0.8" aria-label="Volume" />
      </div>

      <div class="stream-select">
        <select id="quality" aria-label="Stream quality">
          <option value="https://play.radioabf.com:2850/stream">HD MP3 320k</option>
          <option value="https://play.radioabf.com:2860/stream">SD MP3 128k</option>
          <option value="https://play.radioabf.com:2870/stream">BD AAC+ 32k</option>
          <option value="https://play.radioabf.com:2880/stream">UHD FLAC 728k</option>
        </select>
      </div>
    </div>
  </div>

  <canvas id="visualizer"></canvas>

  <div class="player-footer">
    <div>¬© ABF CLUB RADIO ‚Äì A <a href="https://www.radioabf.com" target="_blank" rel="noopener">RadioABF.com</a> Clubbing Experience</div>
    <div id="playerStatus" class="player-status">READY</div>
  </div>

  <audio id="audio" playsinline preload="none" crossorigin="anonymous"></audio>
</div>

<script>
  // ===== Elements =====
  var root = document.documentElement;
  var audio = document.getElementById('audio');
  var fullBtn = document.getElementById('fullBtn');
  var playBtn = document.getElementById('playBtn');
  var muteBtn = document.getElementById('muteBtn');
  var volume = document.getElementById('volume');
  var select = document.getElementById('quality');
  var nowPlayingEl = document.getElementById('nowPlaying');
  var playerTitleEl = document.getElementById('playerTitle');
  var recentTracksEl = document.getElementById('recentTracks');

  var canvas = document.getElementById('visualizer');
  var c = canvas.getContext('2d');

  // Club screen canvas
  var clubNowEl = document.getElementById('clubNow');
  var clubCanvas = document.getElementById('clubViz');
  var clubC = clubCanvas ? clubCanvas.getContext('2d') : null;

  // SVG waveform paths
  var waveHeaderEl = document.getElementById('waveHeader');
  var wavePlayerEl = document.getElementById('wavePlayer');
  var waveClubEl = document.getElementById('waveClub');

  var statusEl = document.getElementById('playerStatus');
  function setStatus(msg){ if(statusEl) statusEl.textContent = String(msg || '').toUpperCase(); }

  // ===== Layout helper: ensure full scroll with fixed player =====
  function updatePlayerHeight(){
    var p = document.getElementById('player');
    if(!p) return;
    var h = p.offsetHeight + 24;
    document.documentElement.style.setProperty('--player-h', h + 'px');
  }

  // ===== Minimal self-tests (console) =====
  function assert(cond, msg){ if(!cond){ console.error('ABF test failed:', msg); } }
  function runSelfTests(){
    assert(!!audio, 'audio element missing');
    assert(!!fullBtn && !!playBtn && !!muteBtn && !!volume && !!select, 'player controls missing');
    assert(!!nowPlayingEl && !!playerTitleEl && !!recentTracksEl, 'metadata elements missing');
    assert(!!waveHeaderEl && !!wavePlayerEl && !!waveClubEl, 'waveform svg path missing');
    assert(!!canvas && !!clubCanvas, 'visualizer canvas missing');

    var ids = ['audio','fullBtn','playBtn','muteBtn','volume','quality','nowPlaying','playerTitle','recentTracks','visualizer','clubViz','clubNow','player','playerStatus','waveHeader','wavePlayer','waveClub'];
    for(var i=0;i<ids.length;i++){
      assert(document.querySelectorAll('#'+ids[i]).length === 1, 'duplicate or missing id: '+ids[i]);
    }
  }
  runSelfTests();

  // ===== Recent Tracks =====
  var STORAGE_KEY = 'abf_recent_tracks_v3';
  var recentHistory = [];
  var lastTitle = '';
  var hasBootstrappedHistory = false;
  var seenFirstTitle = false;

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function loadRecentFromStorage(){
    try{
      var raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return;
      var parsed = JSON.parse(raw);
      if(Array.isArray(parsed) && parsed.length){
        recentHistory = parsed
          .filter(function(x){ return x && typeof x.title === 'string' && typeof x.time === 'string'; })
          .slice(0, 8);
        if(recentHistory.length) lastTitle = recentHistory[0].title;
      }
    } catch(e){}
  }

  function saveRecentToStorage(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(recentHistory.slice(0, 8))); } catch(e){}
  }

  function renderRecent(list){
    if(!list || !list.length){
      recentTracksEl.innerHTML = '<li><span class="track-time">--:--</span><span class="track-title">No track history available yet.</span></li>';
      return;
    }

    recentTracksEl.innerHTML = list
      .slice(0, 8)
      .map(function(t){
        var time = (t && t.time) ? t.time : '--:--';
        var title = (t && t.title) ? t.title : String(t || '');
        return '<li><span class="track-time">' + escapeHtml(time) + '</span><span class="track-title">' + escapeHtml(title) + '</span></li>';
      })
      .join('');
  }

  function pushRecent(title, timeOverride){
    if(!title) return;
    if(title === lastTitle) return;

    var existing = null;
    for(var i=0;i<recentHistory.length;i++){
      if(recentHistory[i].title === title){ existing = recentHistory[i]; break; }
    }

    lastTitle = title;
    var time = '--:--';
    if(existing && existing.time) time = existing.time;
    else if(timeOverride) time = timeOverride;

    recentHistory = recentHistory.filter(function(t){ return t.title !== title; });
    recentHistory.unshift({ title: title, time: time });
    if(recentHistory.length > 8) recentHistory.length = 8;
    saveRecentToStorage();
  }

  loadRecentFromStorage();
  renderRecent(recentHistory);

  // ===== Canvas: crisp on retina =====
  function resizeCanvas(){
    var dpr = window.devicePixelRatio || 1;

    // Main player viz
    var rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
    c.setTransform(dpr, 0, 0, dpr, 0, 0);

    // Club screen viz
    if(clubCanvas && clubC){
      var r2 = clubCanvas.getBoundingClientRect();
      clubCanvas.width = Math.max(1, Math.floor(r2.width * dpr));
      clubCanvas.height = Math.max(1, Math.floor(r2.height * dpr));
      clubC.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
  }

  // ===== Audio setup =====
  audio.crossOrigin = 'anonymous';
  audio.preload = 'none';
  audio.muted = false;
  audio.volume = 1;
  audio.src = select.value;
  setStatus('READY');

  function setPlayingUI(isPlaying){
    if(isPlaying){ playBtn.textContent='‚è∏'; playBtn.classList.add('playing'); }
    else { playBtn.textContent='‚ñ∂'; playBtn.classList.remove('playing'); }
  }

  // ===== WebAudio (sound routed through WebAudio when available) =====
  var ctx = null;
  var analyser = null;
  var srcNode = null;
  var masterGain = null;

  // Kick detection state
  var kickEnv = 0;
  var kickHold = 0;
  var kickThreshold = 0.16;

  function initCtx(){
    if(ctx) return;
    ctx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = ctx.createAnalyser();
    analyser.fftSize = 1024;

    try{
      srcNode = ctx.createMediaElementSource(audio);
      masterGain = ctx.createGain();
      masterGain.gain.value = parseFloat(volume.value) || 0.8;

      srcNode.connect(analyser);
      srcNode.connect(masterGain);
      masterGain.connect(ctx.destination);
    } catch(e){
      console.warn('WebAudio disabled. Playback will use native element output.', e);
      analyser = null;
      srcNode = null;
      masterGain = null;
    }
  }

  function clamp01(v){ return Math.max(0, Math.min(1, v)); }

  // ===== SVG waveform helpers =====
  function buildWavePath(samples, amp){
    var x0 = 40, x1 = 160, y0 = 100;
    var n = samples.length;
    var step = Math.max(1, Math.floor(n / 56));
    var span = (x1 - x0);
    var pts = [];
    var idx = 0;
    for(var i=0;i<n;i+=step){
      var v = samples[i];
      var t = (v - 128) / 128;
      var x = x0 + (idx / 55) * span;
      var y = y0 + t * amp;
      pts.push([x,y]);
      idx++;
      if(idx >= 56) break;
    }
    if(!pts.length) return 'M40 100 L160 100';
    var d = 'M' + pts[0][0].toFixed(1) + ' ' + pts[0][1].toFixed(1);
    for(var j=1;j<pts.length;j++) d += ' L' + pts[j][0].toFixed(1) + ' ' + pts[j][1].toFixed(1);
    return d;
  }

  function buildSyntheticWave(t, amp){
    var x0=40, x1=160, y0=100;
    var span=x1-x0;
    var points=56;
    var d='';
    for(var i=0;i<points;i++){
      var x=x0 + (i/(points-1))*span;
      var ph = (i/(points-1))*Math.PI*4 + t*2.2;
      var y=y0 + Math.sin(ph) * amp * (0.55 + 0.45*Math.sin(t*1.3));
      d += (i===0?'M':' L') + x.toFixed(1) + ' ' + y.toFixed(1);
    }
    return d;
  }

  function setWavePath(d){
    if(waveHeaderEl) waveHeaderEl.setAttribute('d', d);
    if(wavePlayerEl) wavePlayerEl.setAttribute('d', d);
    if(waveClubEl) waveClubEl.setAttribute('d', d);
  }

  function draw(){
    requestAnimationFrame(draw);

    var tNow = performance.now() / 1000;

    if(!analyser){
      root.style.setProperty('--beat', '0');
      root.style.setProperty('--kick', '0');
      root.style.setProperty('--hue', String((tNow * 8) % 360));

      c.clearRect(0,0,canvas.width,canvas.height);
      if(clubC && clubCanvas) clubC.clearRect(0,0,clubCanvas.width,clubCanvas.height);

      setWavePath(buildSyntheticWave(tNow, 10));
      return;
    }

    var freq = new Uint8Array(analyser.frequencyBinCount);
    var td = new Uint8Array(analyser.fftSize);
    analyser.getByteFrequencyData(freq);
    analyser.getByteTimeDomainData(td);

    var sum = 0;
    for(var i=0;i<freq.length;i++) sum += freq[i];
    var avg = sum / freq.length;

    // Beat (overall energy)
    var beat = clamp01(avg / 255);
    beat = clamp01(Math.pow(beat, 1.35));
    root.style.setProperty('--beat', String(beat));

    // Kick (bass transient)
    var bassSum = 0;
    var bassBins = Math.min(8, freq.length);
    for(var bi=0; bi<bassBins; bi++) bassSum += freq[bi];
    var bass = bassSum / (bassBins * 255);

    kickEnv = Math.max(bass, kickEnv * 0.86);
    if(bass > kickThreshold && bass > kickHold) kickHold = bass;
    kickHold *= 0.90;

    var kick = clamp01((kickHold - kickThreshold) / (1 - kickThreshold));
    root.style.setProperty('--kick', String(kick));

    // Color drift (time + energy + kick spikes)
    var hue = (tNow * 10 + beat * 90 + kick * 140) % 360;
    root.style.setProperty('--hue', String(hue));

    // Waveform SVG
    var amp = 8 + beat * 18;
    setWavePath(buildWavePath(td, amp));

    // Main visualizer bars
    c.clearRect(0,0,canvas.width,canvas.height);
    var barW = 4;
    var gap = 2;
    var baseX = 0;
    var ch = canvas.getBoundingClientRect().height;
    var cw = canvas.getBoundingClientRect().width;
    for(var j=0;j<freq.length;j++){
      var v = freq[j];
      var h = v / 3;
      c.fillStyle = 'hsl(' + hue + ', 95%, 62%)';
      c.fillRect(baseX, (ch - h), barW, h);
      baseX += (barW + gap);
      if(baseX > cw) break;
    }

    // Club screen bars (bigger)
    if(clubC && clubCanvas){
      clubC.clearRect(0,0,clubCanvas.width,clubCanvas.height);
      var ch2 = clubCanvas.getBoundingClientRect().height;
      var cw2 = clubCanvas.getBoundingClientRect().width;
      var bw = 8;
      var gp = 3;
      var x = 0;
      for(var k=0;k<freq.length;k++){
        var vv = freq[k];
        var hh = (vv / 255) * (ch2 * 0.95);
        clubC.fillStyle = 'hsla(' + hue + ', 95%, ' + (55 + (k%2)*8) + '%, 0.92)';
        clubC.fillRect(x, (ch2 - hh), bw, hh);
        x += (bw + gp);
        if(x > cw2) break;
      }
    }
  }

  // ===== Fullscreen / Club Screen =====
  function isFullscreen(){
    return !!(document.fullscreenElement || document.webkitFullscreenElement);
  }

  function setClubScreen(on){
    document.body.classList.toggle('club-screen', !!on);
    setTimeout(function(){
      updatePlayerHeight();
      resizeCanvas();
    }, 120);
  }

  function requestFS(el){
    if(el.requestFullscreen) return el.requestFullscreen();
    if(el.webkitRequestFullscreen) return el.webkitRequestFullscreen();
    return Promise.reject(new Error('Fullscreen not supported'));
  }

  function exitFS(){
    if(document.exitFullscreen) return document.exitFullscreen();
    if(document.webkitExitFullscreen) return document.webkitExitFullscreen();
    return Promise.resolve();
  }

  function toggleClubScreen(){
    var rootEl = document.documentElement;
    if(isFullscreen()){
      exitFS().finally(function(){ setClubScreen(false); });
      return;
    }
    requestFS(rootEl)
      .then(function(){ setClubScreen(true); })
      .catch(function(){
        // If fullscreen is blocked, still enable the visual club mode (windowed)
        setClubScreen(true);
      });
  }

  if(fullBtn){
    fullBtn.onclick = function(){ toggleClubScreen(); };
  }

  document.addEventListener('fullscreenchange', function(){ setClubScreen(isFullscreen()); });
  document.addEventListener('webkitfullscreenchange', function(){ setClubScreen(isFullscreen()); });

  // ===== Play/Pause =====
  function togglePlay(){
    audio.muted = false;
    if(masterGain){
      masterGain.gain.value = parseFloat(volume.value) || 0.8;
    } else {
      audio.volume = parseFloat(volume.value) || 0.8;
    }

    if(audio.paused){
      try{ initCtx(); } catch(e){}

      var p;
      if(ctx && ctx.state === 'suspended') p = ctx.resume();
      else p = Promise.resolve();

      return p.then(function(){
        setStatus('CONNECTING');
        return audio.play();
      }).then(function(){
        setPlayingUI(true);
      }).catch(function(err){
        setStatus('BLOCKED');
        console.warn('Play blocked by browser policy. Tap Play again.', err);
      });
    }

    audio.pause();
    setPlayingUI(false);
    setStatus('PAUSED');
    return Promise.resolve();
  }

  playBtn.onclick = function(){ togglePlay(); };

  muteBtn.onclick = function(){
    if(masterGain){
      var isAudible = masterGain.gain.value > 0.0001;
      masterGain.gain.value = isAudible ? 0 : (parseFloat(volume.value) || 0.8);
      muteBtn.textContent = (masterGain.gain.value === 0) ? 'üîá' : 'üîä';
      setStatus((masterGain.gain.value === 0) ? 'MUTED' : 'LIVE');
      return;
    }

    audio.muted = !audio.muted;
    muteBtn.textContent = audio.muted ? 'üîá' : 'üîä';
    setStatus(audio.muted ? 'MUTED' : 'LIVE');
  };

  volume.oninput = function(){
    var v = parseFloat(volume.value);
    if(isNaN(v)) v = 0;
    if(masterGain) masterGain.gain.value = v;
    else audio.volume = v;
  };

  select.onchange = function(){
    updatePlayerHeight();
    var wasPlaying = !audio.paused;
    audio.pause();

    var base = select.value;
    var bust = base + (base.indexOf('?') === -1 ? '?' : '&') + 't=' + Date.now();
    audio.src = bust;
    audio.load();

    root.style.setProperty('--beat', '0');
    root.style.setProperty('--kick', '0');
    setStatus('SWITCHING');

    if(wasPlaying) togglePlay();
    else setPlayingUI(false);
  };

  // Playback lifecycle hints
  audio.addEventListener('play', function(){ setPlayingUI(true); setStatus('CONNECTING'); });
  audio.addEventListener('playing', function(){ setStatus('LIVE'); });
  audio.addEventListener('waiting', function(){ setStatus('BUFFERING'); });
  audio.addEventListener('stalled', function(){ setStatus('STALLED'); });
  audio.addEventListener('pause', function(){ setPlayingUI(false); root.style.setProperty('--beat','0'); root.style.setProperty('--kick','0'); setStatus('PAUSED'); });
  audio.addEventListener('ended', function(){ setStatus('ENDED'); });
  audio.addEventListener('error', function(){
    var code = audio.error ? audio.error.code : 0;
    setStatus('ERROR ' + code);
    console.warn('Audio error', audio.error);
  });

  // ===== Icecast + played.html =====
  var ICECAST_STATUS_URL = 'https://play.radioabf.com:2850/status-json.xsl';
  var PLAYED_URL = 'https://play.radioabf.com:2040/played.html?sid=1';

  function fetchPlayedHistory(){
    return fetch(PLAYED_URL, { cache: 'no-store' })
      .then(function(r){ return r.text(); })
      .then(function(html){
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');

        var rows = Array.from(doc.querySelectorAll('table tr'));
        if(!rows.length) rows = Array.from(doc.querySelectorAll('tr'));

        var items = [];
        for(var i=0;i<rows.length;i++){
          var tds = rows[i].querySelectorAll('td');
          if(!tds || tds.length < 1) continue;

          var a = tds[0].textContent ? tds[0].textContent.trim() : '';
          var b = (tds.length > 1 && tds[1].textContent) ? tds[1].textContent.trim() : '';

          var time = '';
          var title = '';

          if(/^[0-9]{1,2}:[0-9]{2}/.test(a) || /^[0-9]{2}\/[0-9]{2}/.test(a) || /AM|PM/i.test(a)){
            time = a;
            title = b || '';
          } else {
            title = a;
          }

          if(!title) continue;
          if(/^(recent|played|history|time|date)$/i.test(title)) continue;

          items.push({ time: time || '--:--', title: title });
          if(items.length >= 8) break;
        }

        if(items.length){
          recentHistory = items.slice(0, 8);
          if(recentHistory.length) lastTitle = recentHistory[0].title;
          saveRecentToStorage();
          renderRecent(recentHistory);
          hasBootstrappedHistory = true;
          return true;
        }
        return false;
      })
      .catch(function(){ return false; });
  }

  function fetchIcecastMetadata(){
    return fetch(ICECAST_STATUS_URL, { cache:'no-store' })
      .then(function(r){ return r.json(); })
      .then(function(d){
        if(!d || !d.icestats || !d.icestats.source) throw new Error('Bad Icecast payload');

        var sources = d.icestats.source;
        var list = Array.isArray(sources) ? sources : [sources];
        var s = null;
        for(var i=0;i<list.length;i++){
          var it = list[i];
          var mount = it.mount || it.listenurl || it.listen_url || '';
          if(String(mount).indexOf('/stream') !== -1){ s = it; break; }
        }
        if(!s) s = list[0];

        var title = s.title || s.stream_title || s.server_name || 'Live ‚Äì ABF CLUB RADIO';
        nowPlayingEl.textContent = title;
        playerTitleEl.textContent = title;
        document.title = title + ' | ABF CLUB RADIO ‚Äì Official clubbing webradio from RadioABF.com';
        if(clubNowEl) clubNowEl.textContent = title;

        if(hasBootstrappedHistory){
          pushRecent(title);
          renderRecent(recentHistory);
        } else {
          if(!seenFirstTitle){
            lastTitle = title;
            seenFirstTitle = true;
          } else if(title !== lastTitle){
            pushRecent(title, '--:--');
            renderRecent(recentHistory);
          }
        }
      })
      .catch(function(){
        nowPlayingEl.textContent = 'Live ‚Äì ABF CLUB RADIO';
        playerTitleEl.textContent = 'Live ‚Äì ABF CLUB RADIO';
        document.title = 'ABF CLUB RADIO ‚Äì Official clubbing webradio from RadioABF.com';
        if(clubNowEl) clubNowEl.textContent = 'Live ‚Äì ABF CLUB RADIO';
        renderRecent(recentHistory);
      });
  }

  // ===== Init =====
  function initLayout(){
    updatePlayerHeight();
    resizeCanvas();
  }

  window.addEventListener('load', initLayout);
  window.addEventListener('resize', initLayout);

  try{
    if(document.fonts && document.fonts.ready){
      document.fonts.ready.then(function(){ initLayout(); });
    }
  } catch(e){}

  window.addEventListener('orientationchange', function(){ setTimeout(initLayout, 250); });
  setTimeout(initLayout, 250);
  setTimeout(initLayout, 1200);

  try{
    var ro = new ResizeObserver(function(){ initLayout(); });
    ro.observe(document.getElementById('player'));
    ro.observe(canvas);
    if(clubCanvas) ro.observe(clubCanvas);
  } catch(e) {}

  draw();

  // ===== Dynamic Favicon (beat-synced) =====
  var favLink = document.getElementById('dynamicFavicon');
  var favCanvas = document.createElement('canvas');
  favCanvas.width = 32;
  favCanvas.height = 32;
  var favCtx = favCanvas.getContext('2d');

  function updateFavicon(){
    var beat = parseFloat(getComputedStyle(root).getPropertyValue('--beat')) || 0;
    var hue = parseFloat(getComputedStyle(root).getPropertyValue('--hue')) || 200;

    favCtx.clearRect(0,0,32,32);

    // background
    favCtx.fillStyle = 'rgba(5,7,12,0.95)';
    favCtx.fillRect(0,0,32,32);

    // glow circle
    var r = 8 + beat * 6;
    favCtx.beginPath();
    favCtx.arc(16,16,r,0,Math.PI*2);
    favCtx.fillStyle = 'hsla(' + hue + ',100%,60%,0.9)';
    favCtx.shadowColor = 'hsla(' + hue + ',100%,60%,0.9)';
    favCtx.shadowBlur = 10 + beat * 12;
    favCtx.fill();

    // inner pulse
    favCtx.shadowBlur = 0;
    favCtx.beginPath();
    favCtx.arc(16,16,3 + beat * 2,0,Math.PI*2);
    favCtx.fillStyle = '#ffffff';
    favCtx.fill();

    favLink.href = favCanvas.toDataURL('image/png');
  }

  setInterval(updateFavicon, 250);

  fetchPlayedHistory().finally(function(){
    fetchIcecastMetadata();
    setInterval(fetchIcecastMetadata, 15000);

    setTimeout(function(){
      if(!audio.paused && audio.currentTime === 0){
        console.warn('No playback progress detected; switching to SD MP3 as fallback.');
        select.selectedIndex = 1;
        select.onchange();
      }
    }, 2500);
  });

  setInterval(function(){ fetchPlayedHistory(); }, 30000);
</script>

</body>
</html>
